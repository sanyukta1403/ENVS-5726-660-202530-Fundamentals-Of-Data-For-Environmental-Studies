import urllib
import requests
from pprint import pprint
from pathlib import Path
import csv

fema_hazards_zone_url = 'https://hazards.fema.gov/arcgis/rest/services/public/NFHL/MapServer/28/query'

petroleum_file_path = Path('/Users/sanyuktasingh/Desktop/data class/Petroleum Refineries by City.csv')

petroleum_table = []

with open(petroleum_file_path, 'r', encoding='cp1252') as petroleum_file_path:
    reader = csv.reader(petroleum_file_path)
    headers = next(reader)
    petroleum_table.append(headers + ['FEMA_Hazard_Zone']) #new column to put the flood risk data

    for row in reader: #go through each row in csv 
        latitude = row[headers.index('Latitude')] #setting variables equal to info in lat row 
        longitude = row[headers.index('Longitude')]

        if latitude == '' and longitude == '':
            zone = 'No Data'
        else:
            query = {
            'geometry': f'{{"x": {longitude}, "y": {latitude}}}',
                'inSR':'4326',
                'geometryType':'esriGeometryPoint',
                'spatialRel': 'esriSpatialRelIntersects',
                'outFields': 'ZONE_SUBTY',
                'returnGeometry': 'false',
                'f': 'pjson'
                }

            encoded_query = urllib.parse.urlencode(query)
            full_url = fema_hazards_zone_url + "?" + encoded_query
            fema_hazards_zone_data = requests.get(url=full_url).json()

            if len(fema_hazards_zone_data['features']) > 0:
                zone = fema_hazards_zone_data['features'][0]['attributes']['ZONE_SUBTY']

                if zone is None:
                    zone = 'No Data'
            else: zone = 'No Data'

        new_row = row + [zone]
        petroleum_table.append(new_row)

output_file = Path('/Users/sanyuktasingh/Desktop/data class/Task1_Week7.csv')
with open(output_file, 'w', newline="", encoding='cp1252') as f:
    writer = csv.writer(f)
    writer.writerows(petroleum_table)

print(output_file)